<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="./umd/featbit-js-client-sdk.js"></script>
    <title>featbit.co</title>
</head>

<body style="background-color: rgb(217 239 233);">
<h1 style="text-align: center">FeatBit JavaScript SDK Demo</h1>
<script type="text/javascript">
    const secret = '0tCeWVmXxEapqP6DY1ANtwUw22QeKGNk2o8QPdqnl7eQ';
    const flagkey = 'fff';

    window.onload = async (event) => {
        const option = {
            secret: secret,
            api: 'http://localhost:6100',
            devModePassword: '123abc',
            user: {
                name: 'theuser',
                keyId: 'thekeyid',
                customizedProperties: [
                    {
                        'name': 'orgId',
                        'value': '4581'
                    }
                ]
            }
        };

        let idx = 0;
        const users = [
            {
                name: 'Han Meimei',
                keyId: '10584',
                customizedProperties: [
                    {
                        'name': 'age',
                        'value': '18'
                    }
                ]
            },
            {
                name: 'Paul-Alain',
                keyId: '30100',
                customizedProperties: [
                    {
                        'name': 'age',
                        'value': '15'
                    }
                ]
            },
            {
                name: 'Gregoire Dubois',
                keyId: '32862',
                customizedProperties: [
                    {
                        'name': 'age',
                        'value': '19'
                    }
                ]
            },
            {
                name: 'Chloé Duprès',
                keyId: '14156',
                customizedProperties: [
                    {
                        'name': 'age',
                        'value': '21'
                    }
                ]
            },
            {
                name: 'Antoine Thablt',
                keyId: '55180',
                customizedProperties: [
                    {
                        'name': 'age',
                        'value': '40'
                    }
                ]
            },
            {
                name: 'Nate Green',
                keyId: '55774',
                customizedProperties: [
                    {
                        'name': 'age',
                        'value': '31'
                    }
                ]
            },
            {
                name: 'Frank De Loire',
                keyId: '23585',
                customizedProperties: [
                    {
                        'name': 'age',
                        'value': '17'
                    }
                ]
            }];

        var sendFFCall = ({name, keyId, customizedProperties}) => {
            fbClient.identify({
                name,
                keyId,
                customizedProperties
            });

            setTimeout(() => {
                fbClient.variation(flagkey, false);
                idx++;

                setTimeout(() => {
                    const user = users[idx];
                    if (user) {
                        sendFFCall(user);
                    }
                }, 500);
            }, 500)
        }

        // const user = users[idx];
        // sendFFCall(user);

        fbClient.init(option);

        await fbClient.waitUntilReady();
        var r = fbClient.variation(flagkey, false);
        fbClient.on('ff_update', (changes) => {
            // changes has this structure [{id: 'the feature_flag_key', oldValue: theOldValue, newValue: theNewValue }]
            // the type of theOldValue and theNewValue is defined on FeatBit

            fbClient.variation(flagkey, false);
        });
        console.log(typeof r);
    }
</script>
</body>

</html>